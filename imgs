#!/usr/bin/env node

const args = require("minimist")(process.argv.slice(2));
const http = require("http");
const url = require("url");
const path = require("path");
const fs = require("fs");
const imageSize = require("image-size");
const Dir = require("./Dir");
const isImage = require("./isImage");
let password;

function link(str, query)
{
    if (query) {
        if (str.indexOf("?") !== -1) {
            str += "&" + query;
        } else {
            str += "?" + query;
        }
    }
    return str;
}

function parseCookies(cookieHeader)
{
    const cookies = {};
    if (!cookieHeader) return cookies;
    cookieHeader.split(';').forEach(cookie => {
        const parts = cookie.split('=');
        const name = parts[0].trim();
        const value = parts.slice(1).join('=').trim();
        if (name) cookies[name] = value;
    });
    return cookies;
}

function loginHTML(response)
{
    const html = `
<html>
  <head>
    <title>Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
body {
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background: #f0f0f0;
}
form {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
input[type="password"] {
    font-size: 1rem;
    padding: 0.5rem;
    margin-right: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
}
button {
    font-size: 1rem;
    padding: 0.5rem 1rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
button:hover {
    background: #0056b3;
}
    </style>
  </head>
  <body>
    <form method="POST" action="/__login">
      <input type="password" name="password" placeholder="Password" autofocus>
      <button type="submit">Login</button>
    </form>
  </body>
</html>`;
    response.writeHead(200, {"Content-Type": "text/html"});
    response.write(html);
    response.end();
}

if (!args.dir) {
    console.error("No --dir");
    process.exit(1);
}

if (args.dir[args.dir.length - 1] !== "/") {
    args.dir += "/";
}
if (!args.port) {
    console.error("No --port");
    process.exit(1);
}

password = args.password;

if (args.watch) {
    fs.watch(__dirname, ev => {
        console.log("got change", ev);
        process.exit(0);
    });
}

function linksHTML(response, filePath)
{
    fs.readFile(filePath, "utf-8", (err, data) => {
        if (err) {
            response.writeHead(404, {"Content-Type": "text/plain"});
            response.write(err + "\n");
            response.end();
            return;
        }

        const links = data.split("\n").filter(x => x.startsWith("http")).map(x => {
            return `    <p><a href="${link(x)}">${x}</a></p>`;
        }).join("\n");

        response.writeHead(200);
        const payload = `<html>
  <head>
  </head>
  <body>
${links}
  </body>`;

        response.write(payload);
        response.end();
    });
}

function imageHTML(response, filepath)
{
    imageSize(filepath, (err, dimensions) => {
        const str = `
<html>
  <head title="${filepath}">
    <style>
* {
    font-size: 25px;
    margin: 0;
    padding: 0;
}
.imgbox {
    display: grid;
    height: 100%;
}
.center-fit {
    max-width: 100%;
    max-height: 100vh;
    margin: auto;
}
    </style>
  </head>
  <body>
     <p>
&nbsp;
     </p>
     <p>
       &nbsp;&nbsp;&nbsp;&nbsp;<a href="${link(filepath, 'prev')}">Previous</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="${link(filepath, 'next')}">Next</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="${link(path.dirname(filepath))}">Dir</a>
     </p>
     <a href="${link(filepath, 'next')}">
       <div class="imgbox">
         <img class="center-fit" src="${link(filepath, 'data')}"/>
       </div>
     </a>
  </body>
</html>`;
        response.write(str);
        response.end();
    });
}

function dirHTML(url, response, dir, query)
{
    let str = `
<html>
  <head title="${dir.relative}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
* {
  box-sizing: border-box;
}

img {
  width: 100px;
  heigh: 100px;
}
    </style>
  </head>
  <body>
`;
    if (dir.bookmarks) {
        str += `<p><a href="${link(path.join(dir.relative, 'bookmark.url'))}">Bookmarks</a></p>\n`;
    }
    // console.log(dir, dir.relative);
    let images;
    if (query.indexOf("z") !== -1) {
        images = [];
        while (dir.images.length) {
            images.push(dir.images.splice(Math.floor(Math.random() * dir.images.length), 1)[0]);
        }
        if (images.length) {
            str += `<p><a href="${link(dir.relative)}">Unshuffle</a></p>\n`;
        }
    } else {
        images = dir.images;
        if (images.length) {
            str += `<p><a href="${link(dir.relative, 'z')}">Shuffle</a></p>\n`;
        }
    }
    dir.dirs.forEach(dirpath => {
        str += `<p><a href="${link(path.join(dir.relative, dirpath))}">${dirpath}</a></p>
`;
    });
    images.forEach(img => {
        str += `<p><a href="${link(path.join(dir.relative, img))}"><img src="${link(path.join(dir.relative, img), 'data')}"></img></a></p>\n`;
    });
    str += "</body>\n</html>";

    response.write(str);
    response.end();
}

function stat(fp)
{
    try {
        return fs.statSync(fp);
    } catch (err) {
    }
    return undefined;
}

http.createServer(function(request, response) {
    const u = url.parse(request.url);
    u.pathname = decodeURIComponent(u.pathname);
    const query = String(u.query).split("&");
    const cookies = parseCookies(request.headers.cookie);

    // Handle login POST
    if (request.method === 'POST' && u.pathname === '/__login') {
        let body = '';
        request.on('data', chunk => { body += chunk; });
        request.on('end', () => {
            const params = new URLSearchParams(body);
            const submittedPassword = params.get('password');
            if (submittedPassword === password) {
                response.writeHead(302, {
                    'Set-Cookie': `auth=${encodeURIComponent(submittedPassword)}; Path=/; HttpOnly`,
                    'Location': '/'
                });
                response.end();
            } else {
                loginHTML(response);
            }
        });
        return;
    }

    // Check authentication via cookie
    if (password) {
        const authCookie = cookies.auth ? decodeURIComponent(cookies.auth) : null;
        if (authCookie !== password) {
            loginHTML(response);
            return;
        }
    }

    const filePath = path.join(args.dir, u.pathname);
    let statVal = stat(filePath);
    // console.log(filePath, statVal);
    if (!statVal) {
        response.writeHead(301, { Location: link("/") });
        response.end();
        return;
    }

    // console.log(u.query);

    if (statVal.isDirectory()) {
        const d = new Dir(args.dir, filePath);
        // console.log(d);
        // imagesInDir(filePath);
        dirHTML(u, response, d, query);
        return;
    }

    if (statVal.isFile() && isImage(filePath)) {
        // console.log("got here", u.pathname, u.query);
        const d = new Dir(args.dir, path.dirname(filePath));
        if (query.indexOf("data") !== -1) {
            fs.readFile(filePath, "binary", (err, file) => {
                if (err) {
                    response.writeHead(404, {"Content-Type": "text/plain"});
                    response.write(err + "\n");
                    response.end();
                    return;
                }

                response.writeHead(200);
                response.write(file, "binary");
                response.end();
            });
            return;
        }

        if (query.indexOf("next") !== -1 || query.indexOf("prev") !== -1) {
            let idx = d.images.indexOf(path.basename(u.pathname));
            if (idx === -1) {
                imageHTML(response, u.pathname);
                return;
            }
            if (query.indexOf("next") !== -1) {
                if (++idx === d.images.length) {
                    idx = 0;
                }
            } else {
                if (idx-- === 0) {
                    idx = d.images.length - 1;
                }
            }

            response.writeHead(301, { Location: `${link(path.join(d.relative, d.images[idx]))}` });
            response.end();
            return;
        }

        imageHTML(response, u.pathname);
        return;
    } else if (filePath.endsWith(".url")) {
        linksHTML(response, filePath);
        return;
    }

    response.writeHead(404);
    response.end();
    return;

    // console.log(statVal);

    // const filename = path.join(process.cwd(), uri);

    // fs.exists(filename, function(exists) {
    //     if(!exists) {
    //         response.writeHead(404, {"Content-Type": "text/plain"});
    //         response.write("404 Not Found\n");
    //         response.end();
    //         return;
    //     }

    //     if (fs.statSync(filename).isDirectory()) filename += '/index.html';

    //     fs.readFile(filename, "binary", function(err, file) {
    //         if(err) {
    //             response.writeHead(500, {"Content-Type": "text/plain"});
    //             response.write(err + "\n");
    //             response.end();
    //             return;
    //         }

    //         response.writeHead(200);
    //         response.write(file, "binary");
    //         response.end();
    //     });
    // });
}).listen(parseInt(args.port, 10));

console.log(args);
